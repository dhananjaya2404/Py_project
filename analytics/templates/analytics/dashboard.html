{% extends 'core/base.html' %}

{% block title %}Analytics Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-5">
    <h1 class="display-5 fw-bold">Analytics <span class="text-primary">Dashboard</span></h1>
    <button class="btn btn-primary shadow-sm" onclick="window.print()">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-printer me-2"
            viewBox="0 0 16 16">
            <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1" />
            <path
                d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zm1 5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1V7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2zm7 2v3a1 1 0 0 1-1 1H5a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1" />
        </svg>Print Report
    </button>
</div>

{% if no_data %}
<div class="glass-card p-5 text-center">
    <div class="mb-3">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="var(--text-secondary)"
            class="bi bi-graph-up" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M0 0h1v15h15v1H0zm14.817 3.113a.5.5 0 0 1 .07.704l-4.5 5.5a.5.5 0 0 1-.74.037L7.06 6.767l-3.656 5.027a.5.5 0 0 1-.808-.588l4-5.5a.5.5 0 0 1 .758-.06l2.609 2.61 4.15-5.073a.5.5 0 0 1 .704-.07z" />
        </svg>
    </div>
    <h3 class="text-secondary">No analytics data available yet.</h3>
    <p class="text-muted">Start by creating projects and assigning tasks to see insights.</p>
</div>
{% else %}

<!-- KPI Cards -->
<div class="row g-4 mb-5">
    <div class="col-md-4">
        <div class="glass-card kpi-card">
            <div class="kpi-label">Active Projects</div>
            <div class="kpi-value text-primary">{{ total_projects }}</div>
            <div class="small text-muted">Currently tracking</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="glass-card kpi-card">
            <div class="kpi-label">Total Tasks</div>
            <div class="kpi-value text-purple">{{ total_tasks }}</div>
            <div class="small text-muted">Assigned to team</div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="glass-card kpi-card">
            <div class="kpi-label">Platform Status</div>
            <div class="kpi-value">Active</div>
            <div class="small text-success">Real-time synced</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-5">
    <div class="col-md-6">
        <div class="glass-card p-4 h-100">
            <h5 class="mb-4 d-flex align-items-center">
                <span class="p-2 bg-primary rounded-3 me-3" style="--bs-bg-opacity: .15">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="var(--accent-blue)"
                        class="bi bi-pie-chart-fill" viewBox="0 0 16 16">
                        <path
                            d="M15.985 8.5H8.208A.25.25 0 0 1 8 8.245V.013A.25.25 0 0 0 7.745 0 8 8 0 0 0 0 8a8 8 0 0 0 8 8 8.01 8.01 0 0 0 7.745-6.013.25.25 0 0 0-.25-.242z" />
                        <path
                            d="M8 5V.013a.25.25 0 0 0 0 .584v4.991c0 .051.027.098.068.12l4.987 2.494a.25.25 0 0 0 .31-.31z" />
                    </svg>
                </span>
                Tasks by Status
            </h5>
            <div class="chart-container">
                <canvas id="statusChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="glass-card p-4 h-100">
            <h5 class="mb-4 d-flex align-items-center">
                <span class="p-2 bg-purple rounded-3 me-3" style="--bs-bg-opacity: .15">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="var(--accent-purple)"
                        class="bi bi-bar-chart-fill" viewBox="0 0 16 16">
                        <path
                            d="M1 11a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1v-3zm5-4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7zm5-5a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-2a1 1 0 0 1-1-1V2z" />
                    </svg>
                </span>
                Tasks by Priority
            </h5>
            <div class="chart-container">
                <canvas id="priorityChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Project Progress -->
<div class="glass-card p-4 mb-5">
    <h5 class="mb-4 d-flex align-items-center">
        <span class="p-2 bg-success rounded-3 me-3" style="--bs-bg-opacity: .15">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="#10b981" class="bi bi-stack"
                viewBox="0 0 16 16">
                <path
                    d="m14.12 10.163 1.715.858c.22.11.22.424 0 .534L8.267 15.34a.598.598 0 0 1-.534 0L.165 11.555a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.66zM7.733.063a.598.598 0 0 1 .534 0l7.568 3.784a.3.3 0 0 1 0 .535L8.267 8.165a.598.598 0 0 1-.534 0L.165 4.382a.299.299 0 0 1 0-.535L7.733.063z" />
                <path
                    d="m14.12 6.576 1.715.858c.22.11.22.424 0 .534l-7.568 3.784a.598.598 0 0 1-.534 0L.165 7.968a.299.299 0 0 1 0-.534l1.716-.858 5.317 2.659c.505.252 1.1.252 1.604 0l5.317-2.659z" />
            </svg>
        </span>
        Project Lifecycle Completion
    </h5>
    <div class="table-responsive">
        <table class="table">
            <thead>
                <tr>
                    <th>Project Name</th>
                    <th>Tasks</th>
                    <th>Done</th>
                    <th>Progress</th>
                </tr>
            </thead>
            <tbody>
                {% for proj in project_progress %}
                <tr>
                    <td class="fw-bold">{{ proj.project__name }}</td>
                    <td><span class="badge bg-secondary rounded-pill">{{ proj.total_tasks }}</span></td>
                    <td><span class="badge bg-success rounded-pill">{{ proj.completed_tasks }}</span></td>
                    <td style="width: 40%">
                        <div class="d-flex align-items-center">
                            <div class="progress flex-grow-1" style="height: 6px; background: rgba(255,255,255,0.05)">
                                <div class="progress-bar bg-primary" role="progressbar"
                                    style="width: {{ proj.completion_rate }}%; box-shadow: 0 0 10px var(--accent-glow)"
                                    aria-valuenow="{{ proj.completion_rate }}" aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span class="ms-3 small fw-bold">{{ proj.completion_rate }}%</span>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- AI & Sentiments Row -->
<div class="row g-4 mb-5">
    <div class="col-md-7">
        <div class="glass-card p-4 h-100 border-primary" style="border-width: 2px">
            <h5 class="mb-4 d-flex align-items-center">
                <span class="p-2 bg-primary rounded-3 me-3">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="white" class="bi bi-robot"
                        viewBox="0 0 16 16">
                        <path
                            d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5ZM3 8.062C3 6.76 4.235 5.765 5.53 5.881l.156.013c.42.036.834.036 1.255 0l.155-.013C8.397 5.765 9.63 6.76 9.63 8.062v.571c0 .484-.213.916-.549 1.185l1.69 1.69a1.5 1.5 0 0 1-.16 2.22l-1.07 1.07a1.5 1.5 0 0 1-2.122 0L6.155 13.54a1.5 1.5 0 0 1-.16-2.22l1.69-1.69a1.5 1.5 0 0 1-.548-1.185v-.571ZM6.75 6a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5ZM9.25 6a.75.75 0 1 0 0 1.5.75.75 0 0 0 0-1.5Z" />
                        <path
                            d="M16.5 5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM15 5a3.5 3.5 0 1 0-7 0 3.5 3.5 0 0 0 7 0Z" />
                    </svg>
                </span>
                AI Prioritization Engine
            </h5>
            <div class="list-group list-group-flush bg-transparent">
                {% for item in ai_suggestions %}
                <div
                    class="list-group-item bg-transparent border-glass py-3 px-0 d-flex justify-content-between align-items-center animate-fade-in">
                    <div>
                        <div class="fw-bold mb-1 text-primary">{{ item.task.title }}</div>
<div class="small text-white opacity-50 text-uppercase letter-spacing-1">{{ item.task.project.name }}</div>                    </div>
                    <div class="text-end">
                        <span
                            class="badge {% if item.is_suggested_urgent %}bg-danger{% else %}bg-warning text-dark{% endif %} px-3 py-2 rounded-pill">
                            Match Score: {{ item.score }}
                        </span>
                    </div>
                </div>
                {% empty %}
                <div class="text-center py-4 text-muted">No urgent tasks detected by AI.</div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-5">
        <div class="glass-card p-4 h-100">
            <h5 class="mb-4">Recent Team Sentiment</h5>
            <div class="sentiment-feed">
                {% for comment in recent_comments %}
                <div class="mb-4 p-3 rounded-4 glass-panel border-0 {% if comment.sentiment == 'NEGATIVE' %}border-start border-danger border-4{% elif comment.sentiment == 'POSITIVE' %}border-start border-success border-4{% endif %}"
                    style="background: rgba(255,255,255,0.03)">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold small">{{ comment.author.username }}</span>
                        <span
                            class="badge {% if comment.sentiment == 'NEGATIVE' %}bg-danger{% elif comment.sentiment == 'POSITIVE' %}bg-success{% else %}bg-secondary{% endif %} rounded-pill"
                            style="font-size: 0.6rem">
                            {{ comment.sentiment }}
                        </span>
                    </div>
                    <p class="mb-0 small text-secondary">"{{ comment.content|truncatechars:80 }}"</p>
                </div>
                {% empty %}
                <p class="text-center text-muted py-5">No feedback available.</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Global defaults for premium look
    Chart.defaults.color = '#94a3b8';
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(15, 23, 42, 0.9)';
    Chart.defaults.plugins.tooltip.padding = 12;
    Chart.defaults.plugins.tooltip.cornerRadius = 8;

    // Status Chart
    const ctxStatus = document.getElementById('statusChart');
    if (ctxStatus) {
        new Chart(ctxStatus, {
            type: 'bar',
            data: {
                labels: {{ status_labels| safe }},
    datasets: [{
        label: 'Tasks',
        data: {{ status_data| safe }},
        backgroundColor: 'rgba(56, 189, 248, 0.2)',
        borderColor: '#38bdf8',
        borderWidth: 2,
        borderRadius: 6,
        hoverBackgroundColor: 'rgba(56, 189, 248, 0.4)'
                }]
            },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                plugins: { legend: { display: false } },
        scales: {
            y: {
                beginAtZero: true,
                    grid: { color: 'rgba(255,255,255,0.05)' },
                ticks: { stepSize: 1 }
            },
            x: { grid: { display: false } }
        }
    }
        });
    }

    // Priority Chart
    const ctxPriority = document.getElementById('priorityChart');
    if (ctxPriority) {
        new Chart(ctxPriority, {
            type: 'doughnut',
            data: {
                labels: {{ priority_labels| safe }},
    datasets: [{
        data: {{ priority_data| safe }},
        backgroundColor: [
        '#ef4444', // Urgent
        '#f59e0b', // High
        '#3b82f6', // Medium
        '#10b981'  // Low
    ],
        borderWidth: 0,
        hoverOffset: 20
                }]
            },
    options: {
        responsive: true,
            maintainAspectRatio: false,
                cutout: '70%',
                    plugins: {
            legend: {
                position: 'bottom',
                    labels: { usePointStyle: true, padding: 20 }
            }
        }
    }
        });
    }
</script>

{% endif %}
{% endblock %}